<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>創作者小工具 v0.2.5（單檔診斷版）</title>
  <style>
    :root { --bg:#0f1320; --panel:#161b2e; --ink:#e6e9f2; --muted:#aab0c0; --accent:#7aa2ff; --good:#73d673; --warn:#ffd166; --bad:#ff6b6b; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans TC",Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(160deg,#0f1320,#12172a 40%,#0b1020); color:var(--ink)}
    .wrap{max-width:1080px;margin:0 auto;padding:18px}
    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-size:20px;font-weight:800;letter-spacing:.3px;display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid #2a355f;background:#121732;color:#aab0c0}
    .badge.ok{background:#18311f;border-color:#2e6540;color:#bff5c9}
    .badge.err{background:#421d1d;border-color:#7a3333;color:#ffc2c2}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid #222a43;background:#121732;color:var(--ink);padding:8px 12px;border-radius:12px;cursor:pointer;transition:all .2s;font-weight:700}
    .tab[aria-selected="true"]{background:var(--accent);color:#081224;border-color:transparent}
    .panel{background:var(--panel);border:1px solid #1c2442;border-radius:16px;padding:14px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #253055;background:#0e1430;color:var(--ink);outline:none}
    textarea{min-height:84px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:#23305e;border:1px solid #2d3b75;color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn:hover{filter:brightness(1.1)}
    .btn.pri{background:var(--accent);border-color:transparent;color:#0a1530}
    .btn.good{background:var(--good);color:#04220e;border-color:transparent}
    .btn.warn{background:#ffd166;color:#231a00;border-color:transparent}
    .btn.bad{background:#ff6b6b;color:#2b0505;border-color:transparent}
    .card{background:#0c1128;border:1px solid #1a2142;border-radius:14px;padding:12px}
    .hint{color:var(--muted);font-size:12px}
    .footer{opacity:.7;margin-top:18px;font-size:12px;text-align:center}
    canvas{max-width:100%;background:#0b0f22;border:1px solid #283056;border-radius:12px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:10px;border:1px solid #23305a;border-radius:12px;background:#0e1430}
    .item .meta{display:flex;flex-direction:column;gap:4px}
    .item .acts{display:flex;gap:8px}
    .pill{padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block}
    .hr{height:1px;background:#253056;margin:10px 0}
    #log{white-space:pre-wrap;font-size:12px;color:#9fb1ff}
    @media (max-width:900px){ .g2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        創作者小工具 v0.2.5（單檔診斷）
        <span id="js-badge" class="badge">JS: 初始化中…</span>
      </div>
      <nav class="tabs" role="tablist" aria-label="主要功能">
        <button class="tab" role="tab" aria-selected="true" data-tab="char">角色卡</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="commission">委託排單</button>
        <button class="tab" role="tab" aria-selected="false" data-tab="settings">設定/備份/診斷</button>
      </nav>
    </header>

    <!-- 角色卡 -->
    <section class="panel" id="panel-char" role="tabpanel">
      <div class="grid g2">
        <div class="card">
          <div class="grid g2">
            <div><label>角色名稱</label><input id="c-name" placeholder="角色名稱"></div>
            <div><label>稱號 / 別名</label><input id="c-alias" placeholder="稱號或暱稱（可留空）"></div>
            <div><label>年齡 / 種族</label><input id="c-age" placeholder="例如：17 / 人類（可留空）"></div>
            <div><label>代名詞</label><input id="c-pron" placeholder="她 / 他 / they（可留空）"></div>
            <div><label>性格關鍵詞（逗號隔開）</label><input id="c-traits" placeholder="沉著, 外冷內熱, 任性"></div>
            <div><label>代表色（#hex，逗號隔開）</label><input id="c-colors" placeholder="#7aa2ff, #ffd166, #ff6b6b"></div>
          </div>
          <label style="margin-top:10px">外觀描述</label>
          <textarea id="c-looks" placeholder="髮色、髮長、眼型、服裝、配件…"></textarea>
          <div class="grid g2">
            <div><label>語氣 / 口頭禪</label><textarea id="c-voice" placeholder="說話節奏、語尾、常見句型…"></textarea></div>
            <div><label>不可忽略特徵（務必畫對）</label><textarea id="c-must" placeholder="例：異色瞳（左金右藍）、單邊耳墜（右耳）、鎖骨有疤…"></textarea></div>
          </div>
          <div class="grid g2">
            <div><label>常被畫錯的點</label><textarea id="c-mistakes" placeholder="例：袖口黑色、髮夾左側、鞋帶雙色…"></textarea></div>
            <div><label>避雷事項 / 不接受的要素</label><textarea id="c-nope" placeholder="例：不要改瞳色；不接受血腥；不畫機械盔甲…"></textarea></div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn pri" id="btn-render">產生角色卡</button>
            <button class="btn" id="btn-save">儲存到清單</button>
            <button class="btn" id="btn-reset">清空表單</button>
            <span class="hint">→ 右側可預覽 / 匯出 PNG</span>
          </div>
        </div>
        <div class="card">
          <canvas id="cardCanvas" width="900" height="1200" aria-label="角色卡預覽"></canvas>
          <div class="row" style="margin-top:10px">
            <button class="btn good" id="btn-download">下載 PNG</button>
            <button class="btn warn" id="btn-testdraw">測試繪圖</button>
            <select id="cardList" style="min-width:240px"></select>
            <button class="btn" id="btn-load">讀取</button>
            <button class="btn bad" id="btn-del-card">刪除</button>
          </div>
          <div class="hr"></div>
          <div class="row">
            <label>卡面風格</label>
            <select id="theme">
              <option value="midnight">午夜藍</option>
              <option value="sunset">暮霞橘</option>
              <option value="forest">深林綠</option>
              <option value="rose">玫瑰紫</option>
            </select>
            <label>標題字體大小</label>
            <input id="titleSize" type="number" value="44" min="28" max="72" style="width:110px">
          </div>
        </div>
      </div>
    </section>

    <!-- 委託排單 -->
    <section class="panel" id="panel-commission" role="tabpanel" hidden>
      <div class="grid g2">
        <div><label>委託人</label><input id="m-client" placeholder="委託人暱稱 / 名稱"></div>
        <div><label>專案描述</label><input id="m-desc" placeholder="例：半身插圖（簡單背景）"></div>
        <div><label>金額 (NT$)</label><input id="m-price" type="number" min="0" step="1" placeholder="0"></div>
        <div><label>狀態</label>
          <select id="m-status"><option>Queued</option><option>Sketch</option><option>WIP</option><option>Review</option><option>Final</option><option>Delivered</option><option>OnHold</option><option>Canceled</option></select>
        </div>
        <div><label>開始日</label><input id="m-start" type="date"></div>
        <div><label>期限</label><input id="m-due" type="date"></div>
        <div><label>參考連結</label><input id="m-ref" placeholder="https://..."></div>
        <div><label>發票 / 金流連結</label><input id="m-invoice" placeholder="https://..."></div>
        <div><label>備註</label><input id="m-notes" placeholder="備註／注意事項（可留空）"></div>
      </div>
      <div class="row" style="margin:10px 0 16px">
        <button class="btn pri" id="btn-add-job">新增到清單</button>
        <button class="btn" id="btn-export">匯出 JSON</button>
        <input type="file" id="importFile" accept="application/json" style="display:none">
        <button class="btn" id="btn-import">匯入 JSON</button>
        <span class="hint">資料存於本機（localStorage）</span>
      </div>
      <div class="list" id="jobList"></div>

      <div class="hr"></div>
      <div class="row">
        <span class="hint">公開頁面（會下載一個靜態 HTML，丟到網頁空間就能分享）</span>
        <label class="row"><input type="checkbox" id="pub-price" checked>包含金額</label>
        <label class="row"><input type="checkbox" id="pub-notes">包含備註</label>
        <label class="row"><input type="checkbox" id="pub-links" checked>包含連結</label>
        <button class="btn good" id="btn-public">下載公開頁面</button>
      </div>
    </section>

    <!-- 設定/備份/診斷 -->
    <section class="panel" id="panel-settings" role="tabpanel" hidden>
      <div class="card">
        <div class="row">
          <button class="btn warn" id="btn-clear">清除所有本機資料</button>
          <span class="hint">⚠️ 不可復原，請先匯出 JSON 備份</span>
        </div>
        <div class="hr"></div>
        <div><b>診斷資訊</b></div>
        <div id="diag" class="hint"></div>
        <div class="hr"></div>
        <div><b>錯誤日誌</b></div>
        <div id="log"></div>
      </div>
      <div class="footer">Made with ♡ — v0.2.5</div>
    </section>
  </div>

<script>
(function(){
  function $(id){return document.getElementById(id)}
  var badge = $('js-badge'), logEl = $('log');
  function setBadge(state, msg){
    if(!badge) return;
    badge.classList.remove('ok','err');
    if(state==='ok') badge.classList.add('ok');
    if(state==='err') badge.classList.add('err');
    badge.textContent = 'JS: ' + msg;
  }
  function log(s){ if(logEl){ logEl.textContent += (s + '\\n'); } console.log('[v0.2.5]', s); }
  window.addEventListener('error', function(e){
    log('GlobalError: '+ e.message + ' @ ' + (e.filename||'inline') + ':' + (e.lineno||0));
    setBadge('err','有錯誤');
  });

  // Tabs
  function bindTabs(){
    document.querySelectorAll('.tab').forEach(function(btn){
      btn.addEventListener('click', function(){
        document.querySelectorAll('.tab').forEach(function(b){ b.setAttribute('aria-selected','false'); });
        btn.setAttribute('aria-selected','true');
        var tab = btn.getAttribute('data-tab');
        $('panel-char').hidden = (tab!=='char');
        $('panel-commission').hidden = (tab!=='commission');
        $('panel-settings').hidden = (tab!=='settings');
      });
    });
  }

  // Canvas helpers
  var cv, ctx;
  function ensureCanvas(){
    cv = $('cardCanvas');
    if(!cv){ log('Canvas not found'); return false; }
    ctx = cv.getContext && cv.getContext('2d');
    if(!ctx){ log('getContext 失敗：瀏覽器或安全設定禁止繪圖'); return false; }
    return true;
  }
  function rr(ctx,x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
  function wrap(ctx, text,x,y,maxWidth,lineHeight){
    var words = (text||'').split(/\\s+/), line='';
    for(var n=0;n<words.length;n++){
      var test = line + words[n] + ' ';
      if(ctx.measureText(test).width > maxWidth && n>0){ ctx.fillText(line, x, y); line = words[n] + ' '; y += lineHeight; }
      else { line = test; }
    }
    ctx.fillText(line, x, y);
  }
  function section(ctx,x,y,title,content,maxW,lineH){
    ctx.fillStyle='#7aa2ff'; ctx.font='600 16px system-ui'; ctx.fillText(title,x,y);
    ctx.fillStyle='#e6e9f2'; ctx.font='14px system-ui';
    wrap(ctx, content||'', x, y+24, maxWidth=maxW, lineHeight=lineH);
  }
  function pill(ctx,text,x,y){
    var pad=10; ctx.font='12px system-ui'; var w=ctx.measureText(text).width+pad*2;
    ctx.fillStyle='rgba(255,255,255,.08)'; rr(ctx,x,y-16,w,24,12); ctx.fill();
    ctx.fillStyle='#d7dcf0'; ctx.fillText(text,x+pad,y);
  }
  function swatch(ctx,x,y,col){
    ctx.fillStyle=col||'#999'; ctx.beginPath(); ctx.arc(x+18,y+18,18,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x+18,y+18,18,0,Math.PI*2); ctx.stroke();
  }
  function get(id){ var el=$(id); return el?el.value:''; }
  function set(id,v){ var el=$(id); if(el) el.value=v||''; }

  // Character card
  function renderCard(){
    log('renderCard clicked');
    if(!ensureCanvas()){ setBadge('err','Canvas 失敗'); return; }
    try{
      var themes={midnight:{bg:'#0b1024',grad1:'#12204a',grad2:'#09122a',accent:'#7aa2ff'},
                  sunset:{bg:'#1a1010',grad1:'#6b2b10',grad2:'#2b0f0f',accent:'#ffd166'},
                  forest:{bg:'#0e1712',grad1:'#1d3a2a',grad2:'#0a120d',accent:'#7bdcb5'},
                  rose:{bg:'#140e16',grad1:'#3a2142',grad2:'#110912',accent:'#ffb3d9'}};
      var themeKey = (get('theme')||'midnight');
      var t = themes[themeKey] || themes.midnight;
      var titleSize = parseInt(get('titleSize')||'44',10);

      var name = get('c-name') || '角色名稱';
      var alias = get('c-alias');
      var age = get('c-age');
      var pron = get('c-pron');
      var traits = (get('c-traits')||'').split(',');
      var colors = (get('c-colors')||'').split(',');
      var looks = get('c-looks');
      var voice = get('c-voice');
      var must = get('c-must');
      var mistakes = get('c-mistakes');
      var nope = get('c-nope');

      var w=cv.width,h=cv.height;
      var g=ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,t.grad1); g.addColorStop(1,t.grad2);
      ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='rgba(255,255,255,0.15)'; ctx.lineWidth=4; rr(ctx,20,20,w-40,h-40,24); ctx.stroke();

      ctx.fillStyle='#e6e9f2'; ctx.font='700 '+titleSize+'px system-ui'; ctx.fillText(name, 48, 96);
      ctx.fillStyle=t.accent; ctx.font='600 18px system-ui'; ctx.fillText(alias||'', 52, 126);

      ctx.fillStyle='#aab0c0'; ctx.font='14px system-ui';
      ctx.fillText('年齡/種族： '+ (age||''), 52, 156);
      ctx.fillText('代名詞： '+ (pron||''), 300, 156);

      var x=48,y=188;
      for(var i=0;i<traits.length;i++){ var tr=(traits[i]||'').trim(); if(!tr) continue; pill(ctx,tr,x,y); x+=ctx.measureText(tr).width+40; if(x> w-200){ x=48; y+=28; } }

      y+=40; x=48;
      for(var j=0;j<Math.min(colors.length,6);j++){ var col=(colors[j]||'').trim(); if(!col) continue; swatch(ctx,x,y,col); x+=60; }
      ctx.fillStyle='#aab0c0'; ctx.font='12px system-ui'; ctx.fillText('代表色',48,y+70);

      section(ctx,48,y+100,'外觀',looks, w-96, 16);
      section(ctx,48,y+300,'語氣/口頭禪',voice, w-96, 16);
      section(ctx,48,y+460,'不可忽略特徵',must, w-96, 16);
      section(ctx,48,y+620,'常被畫錯',mistakes, w-96, 16);
      section(ctx,48,y+780,'避雷事項',nope, w-96, 16);

      setBadge('ok','運作中');
    }catch(e){ log('renderCard Error: '+ e.message); setBadge('err','renderCard error'); }
  }

  function downloadCard(){
    if(!ensureCanvas()) return;
    try{
      var link = document.createElement('a');
      link.download = (get('c-name') || 'character') + '_card.png';
      link.href = cv.toDataURL('image/png'); link.click();
    }catch(e){ log('downloadCard Error: '+ e.message); }
  }
  function resetCard(){
    ['c-name','c-alias','c-age','c-pron','c-traits','c-colors','c-looks','c-voice','c-must','c-mistakes','c-nope']
      .forEach(function(id){ set(id,''); });
    renderCard();
  }
  function testDraw(){
    if(!ensureCanvas()) return;
    ctx.fillStyle='#2244aa'; ctx.fillRect(20,20,200,120);
    ctx.fillStyle='#fff'; ctx.font='16px system-ui'; ctx.fillText('Canvas OK at '+ new Date().toLocaleTimeString(), 28, 60);
    setBadge('ok','Canvas 測試成功');
    log('testDraw success');
  }

  // Local data
  function getCards(){ try{return JSON.parse(localStorage.getItem('cards_v2')||'[]')}catch(_){return []} }
  function setCards(a){ localStorage.setItem('cards_v2', JSON.stringify(a||[])); }
  function refreshCardList(){
    var sel = $('cardList'); if(!sel) return; sel.innerHTML='';
    var arr=getCards(); for(var i=0;i<arr.length;i++){ var c=arr[i]; var opt=document.createElement('option'); opt.value=i; opt.textContent=(c.name||'未命名'); sel.appendChild(opt); }
  }
  function saveCard(){
    var obj = { name:get('c-name'), alias:get('c-alias'), age:get('c-age'), pron:get('c-pron'),
      traits:get('c-traits'), colors:get('c-colors'), looks:get('c-looks'), voice:get('c-voice'),
      must:get('c-must'), mistakes:get('c-mistakes'), nope:get('c-nope'),
      theme:get('theme'), titleSize:get('titleSize') };
    var arr=getCards(); arr.push(obj); setCards(arr); refreshCardList();
  }
  function loadSelected(){
    var sel=$('cardList'); if(!sel) return;
    var idx=parseInt(sel.value||'-1',10); var arr=getCards(); var c=arr[idx]; if(!c) return;
    set('c-name',c.name); set('c-alias',c.alias); set('c-age',c.age); set('c-pron',c.pron);
    set('c-traits',c.traits); set('c-colors',c.colors); set('c-looks',c.looks); set('c-voice',c.voice);
    set('c-must',c.must); set('c-mistakes',c.mistakes); set('c-nope',c.nope);
    var themeEl=$('theme'); if(themeEl) themeEl.value=c.theme||'midnight';
    var titleEl=$('titleSize'); if(titleEl) titleEl.value=c.titleSize||44;
    renderCard();
  }
  function deleteSelected(){
    var sel=$('cardList'); if(!sel) return;
    var idx=parseInt(sel.value||'-1',10); if(isNaN(idx)) return;
    var arr=getCards(); arr.splice(idx,1); setCards(arr); refreshCardList();
  }

  // Jobs
  var jobListEl;
  function getJobs(){ try{return JSON.parse(localStorage.getItem('jobs_v2')||'[]')}catch(_){return []} }
  function setJobs(a){ localStorage.setItem('jobs_v2', JSON.stringify(a||[])); }
  function uniq(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
  function esc(s){ return (s||'').replace(/[&<>]/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;'}[m]; }); }

  function drawJobs(){
    if(!jobListEl) jobListEl=$('jobList');
    var arr=getJobs(); jobListEl.innerHTML='';
    if(arr.length===0){ var d=document.createElement('div'); d.className='hint'; d.textContent='目前沒有委託，新增一筆吧！'; jobListEl.appendChild(d); return; }
    for(var i=0;i<arr.length;i++){
      var job=arr[i];
      var row=document.createElement('div'); row.className='item';
      var meta=document.createElement('div'); meta.className='meta';
      var t1=document.createElement('div'); t1.innerHTML='<b>'+esc(job.client||'委託人')+'</b> — '+esc(job.desc||'未填寫');
      var t2=document.createElement('div'); t2.innerHTML='狀態： '+esc(job.status||'Queued')+'　金額：NT$ '+(job.price||0)+'　期限：'+esc(job.due||'—');
      var t3=document.createElement('div'); t3.className='hint'; t3.textContent=job.notes||'';
      meta.appendChild(t1); meta.appendChild(t2); meta.appendChild(t3);
      var acts=document.createElement('div'); acts.className='acts';
      function mk(txt,fn,cls){ var b=document.createElement('button'); b.className='btn'+(cls?' '+cls:''); b.textContent=txt; b.addEventListener('click',fn); return b; }
      acts.appendChild(mk('編輯', (function(id){return function(){editJob(id);};})(job.id)));
      acts.appendChild(mk('刪除', (function(id){return function(){delJob(id);};})(job.id), 'bad'));
      acts.appendChild(mk('上移', (function(id){return function(){moveJob(id,-1);};})(job.id)));
      acts.appendChild(mk('下移', (function(id){return function(){moveJob(id,1);};})(job.id)));
      row.appendChild(meta); row.appendChild(acts); jobListEl.appendChild(row);
    }
  }
  function addJob(){
    var job={ id:uniq(), client:get('m-client'), desc:get('m-desc'),
      price:parseInt(get('m-price')||'0',10), status:get('m-status'), start:get('m-start'),
      due:get('m-due'), ref:get('m-ref'), invoice:get('m-invoice'), notes:get('m-notes') };
    var arr=getJobs(); arr.unshift(job); setJobs(arr); drawJobs(); clearJobForm();
  }
  function clearJobForm(){ ['m-client','m-desc','m-price','m-start','m-due','m-ref','m-invoice','m-notes'].forEach(function(id){ set(id,''); }); var s=$('m-status'); if(s) s.value='Queued'; }
  function editJob(id){
    var arr=getJobs(); var idx=-1; for(var i=0;i<arr.length;i++){ if(arr[i].id===id){ idx=i; break; } }
    if(idx<0) return; var j=arr[idx];
    set('m-client',j.client); set('m-desc',j.desc); set('m-price',j.price);
    var se=$('m-status'); if(se) se.value=j.status;
    set('m-start',j.start); set('m-due',j.due);
    set('m-ref',j.ref); set('m-invoice',j.invoice); set('m-notes',j.notes);
    arr.splice(idx,1); setJobs(arr); drawJobs();
  }
  function delJob(id){ var arr=getJobs().filter(function(j){return j.id!==id}); setJobs(arr); drawJobs(); }
  function moveJob(id,dir){
    var arr=getJobs(); var idx=-1; for(var i=0;i<arr.length;i++){ if(arr[i].id===id){ idx=i; break; } }
    var ni=idx+dir; if(idx<0||ni<0||ni>=arr.length) return; var it=arr.splice(idx,1)[0]; arr.splice(ni,0,it); setJobs(arr); drawJobs();
  }
  function exportJSON(){
    try{
      var data={cards:getCards(), jobs:getJobs()};
      var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      var a=document.createElement('a'); a.download='creator_tools_backup_v0_2_5.json'; a.href=URL.createObjectURL(blob); a.click();
    }catch(e){ log('exportJSON Error: '+ e.message); }
  }
  function importJSON(ev){
    var file=ev.target.files[0]; if(!file) return;
    var reader=new FileReader();
    reader.onload=function(){
      try{
        var data=JSON.parse(reader.result||'{}');
        if(data.cards) localStorage.setItem('cards_v2', JSON.stringify(data.cards));
        if(data.jobs) localStorage.setItem('jobs_v2', JSON.stringify(data.jobs));
        refreshCardList(); drawJobs();
      }catch(e){ log('匯入失敗：'+ e.message); }
    };
    reader.readAsText(file);
  }
  function generatePublic(){
    try{
      var includePrice=$('pub-price').checked;
      var includeNotes=$('pub-notes').checked;
      var includeLinks=$('pub-links').checked;
      var data=getJobs();
      var html='<!doctype html><html lang="zh-Hant"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>委託進度追蹤</title>';
      html+='<style>body{font-family:ui-sans-serif,system-ui,\\'Noto Sans TC\\';background:#0f1320;color:#e6e9f2;margin:0;padding:20px}.wrap{max-width:900px;margin:0 auto}h1{font-size:22px;margin:0 0 10px}.hint{color:#aab0c0;font-size:12px;margin-bottom:12px}.item{border:1px solid #23305a;border-radius:12px;padding:10px;margin:8px 0;background:#0e1430}.pill{padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px;display:inline-block;margin-left:6px}a{color:#7aa2ff}</style>';
      html+='<div class="wrap"><h1>委託進度追蹤</h1><div class="hint">最後更新：'+ new Date().toLocaleString() +'</div>';
      for(var i=0;i<data.length;i++){
        var j=data[i];
        html+='<div class="item"><div><b>'+esc(j.client||'委託人')+'</b> — '+esc(j.desc||'未填寫')+'</div>';
        html+='<div style="font-size:14px;margin-top:4px">期限：'+esc(j.due||'—')+'　開始：'+esc(j.start||'—')+(includePrice?('　金額：NT$ '+esc(String(j.price||0))):'')+'</div>';
        if(includeLinks && (j.ref||j.invoice)){
          html+='<div style="font-size:14px;margin-top:2px">';
          if(j.ref){ html+='參考：<a href="'+(j.ref||'')+'" target="_blank">連結</a>　'; }
          if(j.invoice){ html+='金流：<a href="'+(j.invoice||'')+'" target="_blank">連結</a>'; }
          html+='</div>';
        }
        if(includeNotes && j.notes){ html+='<div style="color:#aab0c0;font-size:12px;margin-top:6px)">'+esc(j.notes)+'</div>'; }
        html+='</div>';
      }
      html+='<div class="hint" style="margin-top:12px">Powered by 角色卡 & 委託排單（離線版）</div></div>';
      var blob=new Blob([html],{type:'text/html'});
      var a=document.createElement('a'); a.download='commission_status.html'; a.href=URL.createObjectURL(blob); a.click();
    }catch(e){ log('generatePublic Error: '+ e.message); }
  }

  function setup(){
    setBadge('ok','運作中');
    bindTabs();

    $('btn-render')&&$('btn-render').addEventListener('click', renderCard);
    $('btn-download')&&$('btn-download').addEventListener('click', downloadCard);
    $('btn-reset')&&$('btn-reset').addEventListener('click', resetCard);
    $('btn-testdraw')&&$('btn-testdraw').addEventListener('click', testDraw);
    $('btn-save')&&$('btn-save').addEventListener('click', saveCard);
    $('btn-load')&&$('btn-load').addEventListener('click', loadSelected);
    $('btn-del-card')&&$('btn-del-card').addEventListener('click', deleteSelected);

    $('btn-add-job')&&$('btn-add-job').addEventListener('click', addJob);
    $('btn-export')&&$('btn-export').addEventListener('click', exportJSON);
    $('btn-import')&&$('btn-import').addEventListener('click', function(){ $('importFile').click(); });
    $('importFile')&&$('importFile').addEventListener('change', importJSON);
    $('btn-public')&&$('btn-public').addEventListener('click', generatePublic);
    $('btn-clear')&&$('btn-clear').addEventListener('click', function(){ localStorage.removeItem('cards_v2'); localStorage.removeItem('jobs_v2'); refreshCardList(); drawJobs(); log('已清除本機資料'); });

    $('theme')&&$('theme').addEventListener('change', renderCard);
    $('titleSize')&&$('titleSize').addEventListener('input', renderCard);

    try{ renderCard(); refreshCardList(); drawJobs(); }catch(e){ log('Init Error: '+ e.message); }
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', setup);
  }else{
    try{ setup(); }catch(e){ log('Setup fallback error: '+ e.message); }
  }
})();
</script>
</body>
</html>
